import { hilog } from '@kit.PerformanceAnalysisKit';
import common from '@ohos.app.ability.common';
import fs from '@ohos.file.fs';
import {
  IKaraokeEvent,
  KaraokeView,
  LyricModel,
  LyricsLineModel,
  LyricsView,
  ScoringView,
  Utils
} from 'lyrics_view';

/**
 * å¡æ‹‰OKäº‹ä»¶ç›‘å¬å™¨å®ç°
 */
class KaraokeEventImpl implements IKaraokeEvent {
  private indexComponent: Index;

  constructor(indexComponent: Index) {
    this.indexComponent = indexComponent;
  }

  onKaraokeReady(): void {
    this.indexComponent.logDebug('ğŸ‰ All karaoke components are ready!');
    this.indexComponent.handleKaraokeReady();
  }

  onDragTo(progress: number): void {
    this.indexComponent.logDebug(`onDragTo: ${progress}ms`);
    this.indexComponent.handleDragTo(progress);
  }

  onLineFinished(line: LyricsLineModel, score: number, cumulativeScore: number, index: number,
    lineCount: number): void {
    this.indexComponent.logDebug(`Line ${index} finished with score ${score}`);
  }
}

@Entry
@Component
struct Index {
  @State lyricsDescription: string = '';
  @State playingProgress: string = '0ms';
  @State callBackInfo: string = '';
  @State currentTime: number = 0;
  @State isPlaying: boolean = false;
  @State currentSongIndex: number = 0;
  @State isOriginalTrack: boolean = false;
  // å¡æ‹‰OKç›¸å…³
  private karaokeView: KaraokeView | null = null;
  @State lyricModel: LyricModel | null = null;
  // ç§»é™¤ç»„ä»¶å¼•ç”¨ï¼Œé‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„æ–¹å¼
  private timer: number = -1;
  private songList: string[] = ['åå¹´', 'æœˆäº®ä»£è¡¨æˆ‘çš„å¿ƒ', 'ç«¥è¯'];

  aboutToAppear() {
    this.updateLyricsDescription();
    this.initKaraokeView();
  }

  /**
   * åˆå§‹åŒ–KaraokeViewï¼Œåœ¨ç»„ä»¶å®ä¾‹åˆ›å»ºåè°ƒç”¨
   */
  private initKaraokeView() {
    if (!this.karaokeView) {
      // åˆ›å»ºKaraokeViewå®ä¾‹ï¼Œä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°
      this.karaokeView = new KaraokeView();

      // è®¾ç½®æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
      const eventListener = new KaraokeEventImpl(this);
      this.karaokeView.setKaraokeEvent(eventListener);
    }
  }

  aboutToDisappear() {
    this.stopPlayback();
  }

  /**
   * å¤„ç†å¡æ‹‰OKç»„ä»¶å‡†å¤‡å°±ç»ªäº‹ä»¶
   */
  public handleKaraokeReady() {
    this.callBackInfo = 'ğŸ‰ æ‰€æœ‰å¡æ‹‰OKç»„ä»¶å·²å‡†å¤‡å°±ç»ªï¼';
    this.logDebug('KaraokeView components are ready, can now safely use all features');

    this.loadSong();
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨ï¼Œåˆ›å»ºå¿…è¦ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
   */
  private async loadSong() {
    try {
      await this.ensureLyricsDirectory();
      await this.copyRawFilesToPrivate();
      await this.loadCurrentSong();
    } catch (error) {
      this.logDebug(`Failed to initialize app: ${error}`);
      this.callBackInfo = `åˆå§‹åŒ–å¤±è´¥: ${error}`;
    }
  }

  public logDebug(message: string) {
    hilog.debug(0x0000, "LyricsView-Main", message);
  }

  /**
   * ç¡®ä¿lyricsç›®å½•å­˜åœ¨
   */
  private async ensureLyricsDirectory(): Promise<string> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const lyricsDir = `${context.filesDir}/lyrics`;

      this.logDebug(`App files directory: ${context.filesDir}`);
      this.logDebug(`Checking lyrics directory: ${lyricsDir}`);

      // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
      if (!fs.accessSync(lyricsDir)) {
        this.logDebug(`Creating lyrics directory: ${lyricsDir}`);
        fs.mkdirSync(lyricsDir);
        this.logDebug(`Successfully created lyrics directory`);
        this.callBackInfo = `å·²åˆ›å»ºæ­Œè¯ç›®å½•`;
      } else {
        this.logDebug(`Lyrics directory already exists`);
        this.callBackInfo = `æ­Œè¯ç›®å½•å·²å­˜åœ¨`;
      }

      return lyricsDir;
    } catch (error) {
      this.logDebug(`Failed to ensure lyrics directory: ${error}`);
      throw new Error(`Failed to ensure lyrics directory: ${error}`);
    }
  }

  /**
   * å°†å†…å®¹å†™å…¥ç§æœ‰ç›®å½•æ–‡ä»¶
   */
  private async writePrivateFile(filePath: string, content: string): Promise<void> {
    try {
      const file = fs.openSync(filePath, fs.OpenMode.WRITE_ONLY | fs.OpenMode.CREATE);
      const buffer = Utils.stringToUint8Array(content);
      fs.writeSync(file.fd, buffer.buffer as ArrayBuffer);
      fs.closeSync(file);

      this.logDebug(`Successfully wrote file: ${filePath}`);
    } catch (error) {
      this.logDebug(`Failed to write file ${filePath}: ${error}`);
      throw new Error(`Failed to write file ${filePath}: ${error}`);
    }
  }

  /**
   * ä»rawfileå¤åˆ¶æ–‡ä»¶åˆ°ç§æœ‰ç›®å½•
   */
  private async copyRawFilesToPrivate(): Promise<void> {
    try {
      const lyricsDir = await this.ensureLyricsDirectory();
      const context = getContext(this) as common.UIAbilityContext;

      // å®šä¹‰è¦å¤åˆ¶çš„æ–‡ä»¶åˆ—è¡¨
      const filesToCopy = [
        '4875936889260991133.krc',
        '4875936889260991133.pitch'
      ];

      for (const fileName of filesToCopy) {
        const targetPath = `${lyricsDir}/${fileName}`;

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤å¤åˆ¶
        if (fs.accessSync(targetPath)) {
          this.logDebug(`File already exists, skipping: ${targetPath}`);
          continue;
        }

        try {
          // ä½¿ç”¨Utilsç›´æ¥ä»rawfileè¯»å–å†…å®¹
          const content = await Utils.loadAsString(context, fileName);
          if (!content) {
            throw new Error(`Failed to load rawfile: ${fileName}`);
          }

          // ä½¿ç”¨Utilså†™å…¥æ–‡ä»¶
          await this.writePrivateFile(targetPath, content);

          this.logDebug(`Successfully copied ${fileName} to ${targetPath}`);

        } catch (error) {
          this.logDebug(`Failed to copy ${fileName}: ${error}`);
          // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
        }
      }

      this.callBackInfo = `æ–‡ä»¶å¤åˆ¶å®Œæˆ`;

      // åˆ—å‡ºç›®å½•å†…å®¹è¿›è¡ŒéªŒè¯
      await this.listDirectoryContents(lyricsDir);

    } catch (error) {
      this.logDebug(`Failed to copy raw files: ${error}`);
      this.callBackInfo = `æ–‡ä»¶å¤åˆ¶å¤±è´¥: ${error}`;
      throw new Error(`Failed to copy raw files: ${error}`);
    }
  }

  /**
   * åˆ—å‡ºç›®å½•å†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
   */
  private async listDirectoryContents(dirPath: string): Promise<void> {
    try {
      if (fs.accessSync(dirPath)) {
        const files = fs.listFileSync(dirPath);
        this.logDebug(`Directory ${dirPath} contains: ${JSON.stringify(files)}`);
        this.callBackInfo = `ç›®å½•åŒ…å« ${files.length} ä¸ªæ–‡ä»¶`;
      } else {
        this.logDebug(`Directory ${dirPath} does not exist`);
      }
    } catch (error) {
      this.logDebug(`Failed to list directory ${dirPath}: ${error}`);
    }
  }

  /**
   * åŠ è½½å½“å‰æ­Œæ›²çš„KRCæ–‡ä»¶
   */
  private async loadCurrentSong() {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const lyricFilePath = `${context.filesDir}/lyrics/4875936889260991133.krc`;
      const pitchFilePath = `${context.filesDir}/lyrics/4875936889260991133.pitch`;

      this.logDebug(`lyricFilePath: ${lyricFilePath} pitchFilePath: ${pitchFilePath}`);

      // éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      if (!fs.accessSync(lyricFilePath)) {
        throw new Error(`KRC file not found: ${lyricFilePath}`);
      }

      if (!fs.accessSync(pitchFilePath)) {
        throw new Error(`Pitch file not found: ${pitchFilePath}`);
      }

      // 1. ä½¿ç”¨parseLyricsè§£ææ­Œè¯ï¼ˆä¼ å…¥æ–‡ä»¶è·¯å¾„ï¼‰
      this.lyricModel = KaraokeView.parseLyrics(lyricFilePath, pitchFilePath, true, 0);

      if (!this.lyricModel) {
        throw new Error('Failed to parse lyrics');
      }

      // 2. å¦‚æœKaraokeViewå·²åˆå§‹åŒ–ï¼Œè®¾ç½®æ­Œè¯æ•°æ®
      if (this.karaokeView) {
        this.karaokeView.setLyricData(this.lyricModel, false);
      }

      this.logDebug(`Successfully loaded lyrics with ${this.lyricModel.lines?.length || 0} lines`);

    } catch (error) {
      console.error('Failed to load song:', error);
      this.callBackInfo = `åŠ è½½å¤±è´¥: ${error}`;
      this.logDebug(`Failed to load song: ${error}`);
    }
  }

  private updateLyricsDescription() {
    this.lyricsDescription = `å½“å‰æ­Œæ›²: ${this.songList[this.currentSongIndex]} `;
  }

  private startPlayback() {
    if (this.isPlaying) {
      return;
    }

    if (!this.lyricModel) {
      this.callBackInfo = 'è¯·å…ˆåŠ è½½æ­Œè¯æ–‡ä»¶';
      return;
    }

    this.isPlaying = true;
    // ä½¿ç”¨20msé—´éš”çš„å®šæ—¶å™¨ï¼Œæ›´ç²¾ç¡®åœ°æ¨¡æ‹Ÿæ’­æ”¾
    this.timer = setInterval(() => {
      this.currentTime += 20; // æ¯20mså¢åŠ 20ms
      this.playingProgress = `${this.currentTime}ms`;

      // è°ƒç”¨KaraokeViewçš„setProgressæ–¹æ³•ï¼ˆè¿™ä¼šè§¦å‘LyricMachine.setProgress â†’ LyricsView.requestRefreshUi â†’ updateByProgressï¼‰
      if (this.karaokeView) {
        this.karaokeView.setProgress(this.currentTime);
      }

      // æ¨¡æ‹Ÿæ’­æ”¾ç»“æŸï¼ˆ3åˆ†é’Ÿï¼‰
      if (this.currentTime >= 180000) {
        this.stopPlayback();
      }
    }, 20); // 20msé—´éš”

    this.callBackInfo = 'å¼€å§‹æ’­æ”¾';
  }

  private pausePlayback() {
    this.isPlaying = false;
    if (this.timer !== -1) {
      clearInterval(this.timer);
      this.timer = -1;
    }
    this.callBackInfo = 'æš‚åœæ’­æ”¾';
  }

  private stopPlayback() {
    this.pausePlayback();
    this.currentTime = 0;
    this.playingProgress = '0ms';
    this.callBackInfo = 'åœæ­¢æ’­æ”¾';
  }

  private async switchToNext() {
    this.stopPlayback();
    this.currentSongIndex = (this.currentSongIndex + 1) % this.songList.length;
    this.updateLyricsDescription();
    this.callBackInfo = `æ­£åœ¨åŠ è½½: ${this.songList[this.currentSongIndex]}`;

    // é‡æ–°åŠ è½½æ–°æ­Œæ›²çš„KRCæ–‡ä»¶
    await this.loadCurrentSong();
  }

  private skipIntro() {


    // åŒæ­¥æ›´æ–°KaraokeViewçš„è¿›åº¦ï¼ˆè§¦å‘æ­Œè¯æ˜¾ç¤ºæ›´æ–°ï¼‰
    if (this.lyricModel && this.karaokeView) {
      const preludeEndPosition = this.lyricModel.preludeEndPosition - 1000;
      this.currentTime = preludeEndPosition;
      this.playingProgress = `${preludeEndPosition}ms`;
      this.callBackInfo = 'è·³è¿‡å‰å¥';

      this.karaokeView.setProgress(preludeEndPosition);
    }
  }

  private toggleOriginalTrack() {
    this.isOriginalTrack = !this.isOriginalTrack;
    this.callBackInfo = this.isOriginalTrack ? 'åˆ‡æ¢åˆ°åŸå”±' : 'åˆ‡æ¢åˆ°ä¼´å¥';
  }

  private openSettings() {
    this.callBackInfo = 'è®¾ç½®åŠŸèƒ½å¾…å®ç°';
  }

  /**
   * å¤„ç†æ‹–æ‹½ç»“æŸäº‹ä»¶
   * @param finalProgress æœ€ç»ˆæ‹–æ‹½ä½ç½®ï¼ˆæ¯«ç§’ï¼‰
   */
  public handleDragTo(finalProgress: number) {
    // æ›´æ–°å½“å‰æ—¶é—´åˆ°æ‹–æ‹½çš„æœ€ç»ˆä½ç½®
    this.currentTime = finalProgress;
    this.playingProgress = `${this.currentTime}ms`;
    this.callBackInfo = `æ‹–æ‹½åˆ°: ${this.currentTime}ms`;

    // åŒæ­¥æ›´æ–°KaraokeViewçš„è¿›åº¦
    if (this.karaokeView) {
      this.karaokeView.setProgress(this.currentTime);
    }
  }

  @Builder
  LyricsViewBuilder() {
    // ç›´æ¥ä½¿ç”¨LyricsViewç»„ä»¶ï¼Œæ‰€æœ‰é€»è¾‘ç”±ç»„ä»¶å†…éƒ¨å¤„ç†
    LyricsView({
      textSize: 16,
      currentLineTextSize: 20,
      currentLineTextColor: '#FFFF00',
      currentLineHighlightedTextColor: '#FFF44336',
      previousLineTextColor: '#FFFFFF',
      upcomingLineTextColor: '#FFFFFF',
      lineSpacing: 15,
      paddingTop: 15,
      labelWhenNoLyrics: 'æš‚æ— æ­Œè¯',
      enableLineWrap: false,
      enableDragging: true,
      enablePreviousLines: true,
      enableUpcomingLines: true,
      enablePreludeEndPositionIndicator: true,
      preludeEndPositionIndicatorPaddingTop: 5,
      preludeEndPositionIndicatorRadius: 4,
      preludeEndPositionIndicatorColor: '#FF6B35',
      textGravity: 0
    })
      .width('100%')
      .height('100%')
  }

  @Builder
  ScoringViewBuilder() {
    // ä½¿ç”¨çœŸå®çš„ScoringViewç»„ä»¶ï¼Œæ‰€æœ‰é€»è¾‘ç”±ç»„ä»¶å†…éƒ¨å¤„ç†
    ScoringView({
      // ScoringViewçš„é…ç½®å‚æ•°
    })
      .width('100%')
      .height('100%')
  }

  build() {
    Stack() {
      Column() {
        // æ­Œè¯æè¿°ä¿¡æ¯
        Row() {
          Text(this.lyricsDescription)
            .fontSize(12)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
        .height(40)
        .padding({ left: 8, right: 8, top: 4 })
        .alignItems(VerticalAlign.Top)
        .justifyContent(FlexAlign.Start)

        // è¯„åˆ†è§†å›¾åŒºåŸŸ
        Row() {
          this.ScoringViewBuilder()
        }
        .width('100%')
        .height(300)
        .backgroundColor('#FFE0B2')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 20 })

        // æ­Œè¯è§†å›¾åŒºåŸŸ
        Stack() {
          this.LyricsViewBuilder()

          // æ’­æ”¾è¿›åº¦æ˜¾ç¤º
          Text(this.playingProgress)
            .fontSize(12)
            .fontColor('#333333')
            .backgroundColor('#FFFFFF80')
            .padding(4)
            .borderRadius(4)
            .position({ x: 8, y: 0 })
        }
        .width('100%')
        .height(300)
        .backgroundColor('#CE93D8')
        .layoutWeight(1)

        // å›è°ƒä¿¡æ¯æ˜¾ç¤º
        Row() {
          Text(this.callBackInfo)
            .fontSize(12)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
        .height(30)
        .padding({ left: 8, right: 8 })
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Center)

        // ä¸»è¦æ§åˆ¶æŒ‰é’®
        Row({ space: 8 }) {
          Button(this.isPlaying ? 'æš‚åœ' : 'æ’­æ”¾')
            .fontSize(14)
            .backgroundColor(this.isPlaying ? '#FF9800' : '#4CAF50')
            .onClick(() => {
              if (this.isPlaying) {
                this.pausePlayback();
              } else {
                this.startPlayback();
              }
            })

          Button('åˆ‡æ¢æ­Œæ›²')
            .fontSize(14)
            .backgroundColor('#2196F3')
            .onClick(() => {
              this.switchToNext();
            })

          Button('è·³è¿‡å‰å¥')
            .fontSize(14)
            .backgroundColor('#9C27B0')
            .onClick(() => {
              this.skipIntro();
            })
        }
        .width('100%')
        .height(50)
        .justifyContent(FlexAlign.Center)
        .padding({ bottom: 8 })

        // æ¬¡è¦æ§åˆ¶æŒ‰é’®
        Row({ space: 8 }) {
          Button(this.isOriginalTrack ? 'æ’­æ”¾ä¼´å¥' : 'æ’­æ”¾åŸå”±')
            .fontSize(14)
            .backgroundColor('#607D8B')
            .onClick(() => {
              this.toggleOriginalTrack();
            })

          Button('è®¾ç½®')
            .fontSize(14)
            .backgroundColor('#795548')
            .onClick(() => {
              this.openSettings();
            })
        }
        .width('100%')
        .height(50)
        .justifyContent(FlexAlign.Center)
        .padding({ bottom: 8 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
