import { IScoringAlgorithm } from '../IScoringAlgorithm';
import { OnScoringListener, ScoringMachine } from '../internal/ScoringMachine';
import { ParticleConfig, ParticleRenderer, ParticleSystem, Range } from '../internal/particle';
import { LyricModel } from '../model/LyricModel';
import { LyricsLineModel } from '../model/LyricsLineModel';
import { HighlightSegment, Pitch, PitchStickData } from '../model/PitchLineModel';
import { EventBus, KaraokeEvents, ScoringEvents } from '../utils/EventBus';
import { LogUtils } from '../utils/LogUtils';

/**
 * è¯„åˆ†æ˜¾ç¤ºç»„ä»¶ - HarmonyOSç‰ˆæœ¬ (ArkUI V2)
 * å¯¹åº”Androidé¡¹ç›®ä¸­çš„ScoringView
 * ç”¨äºæ˜¾ç¤ºå¡æ‹‰OKè¯„åˆ†ä¿¡æ¯å’ŒéŸ³è°ƒå¯è§†åŒ–
 */
@ComponentV2
export struct ScoringView {
  @Param viewBackgroundColor: string = '#ffffbb33'; // å¯é…ç½®çš„èƒŒæ™¯é¢œè‰²
  @Param leadingLinesColor: string = '#4DFFFFFF'
  @Param leadingLinesHeight: number = 1
  @Param pitchIndicatorColor: string = '#F0F0F0F0';
  @Param pitchIndicatorWidth: number = 3;
  @Param localPitchIndicatorColor: string = "#F0F0F0F0"
  @Param localPitchIndicatorRadius: number = 8;
  @Param pitchStickHeight: number = 4;
  @Param pitchStickRadius: number = 4;
  @Param refPitchStickDefaultColor: string = '#99FFFFFF';
  @Param highlightedPitchStickColor: string = '#FFF44336';
  @Param initialScore: number = 0;
  @Param movingPixelsPerMs: number = 0.2;
  @Param hitScoreThreshold: number = 0.7;
  @Param startPointHorizontalBias: number = 0.4;
  @Param enableParticleEffect: boolean = true;
  // ç§»é™¤æ—¶é—´è¡¥å¿æœºåˆ¶ - åº”è¯¥ä»æ ¹æœ¬åŸå› è§£å†³åŒæ­¥é—®é¢˜
  // çŠ¶æ€å˜é‡
  @Local currentScore: number = 0;
  @Local cumulativeScore: number = 0;
  @Local localPitch: number = 0; // åŸå§‹è¾“å…¥çš„pitchå€¼ï¼ˆå¯èƒ½æœ‰æŠ–åŠ¨ï¼‰
  @Local inHighlightStatus: boolean = false;
  @Local animatedPitch: number = 0; // å¹³æ»‘åçš„pitchå€¼ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
  @Local animatedProgressMs: number = 0;
  @Local preHighlightStatus: boolean = false;
  // ç”¨äºè·Ÿè¸ªpitchçŠ¶æ€å˜åŒ–ï¼Œå®ç°ç«‹å³å“åº”é€»è¾‘
  private lastLocalPitch: number = 0;
  // ç€è‰²ç›¸å…³çŠ¶æ€ - å¯¹åº”Androidç‰ˆæœ¬
  private pitchHighlightedTime: number = -1; // å½“å‰ç€è‰²å¼€å§‹æ—¶é—´
  // UIå¸ƒå±€ç›¸å…³
  @Local centerXOfStartPoint: number = 0;
  @Local viewWidth: number = 0;
  @Local viewHeight: number = 0;
  @Local pitchIndicatorY: number = 0; // éŸ³è°ƒæŒ‡ç¤ºå™¨çš„Yåæ ‡
  @Local pitchSticks: PitchStickData[] = []; // å½“å‰å¯è§çš„pitchæ¡æ•°æ®
  // ç²’å­ç³»ç»Ÿç›¸å…³
  @Local particleSystem: ParticleSystem | null = null;
  private emittingInitialized: boolean = false;
  // å†…éƒ¨å˜é‡
  private eventBus: EventBus = EventBus.getInstance();
  private scoringMachine: ScoringMachine | null = null;
  private frameLoopRunning: boolean = false;
  private frameTimer: number = -1;

  build() {
    // ä¸»è¦çš„éŸ³è°ƒå¯è§†åŒ–åŒºåŸŸ - ä½¿ç”¨ç›¸å¯¹å¸ƒå±€è€Œéç»å¯¹å®šä½
    Stack({ alignContent: Alignment.TopStart }) {
      // ç¬¬1å±‚ï¼šèƒŒæ™¯çº¿æ¡ï¼ˆæœ€åº•å±‚ï¼‰
      this.buildBackgroundLines()

      // ç¬¬2å±‚ï¼šæ¸å˜é®ç½©åŒºåŸŸï¼ˆåœ¨èƒŒæ™¯çº¿æ¡ä¹‹ä¸Šï¼Œåœ¨èµ·å§‹çº¿ä¹‹ä¸‹ï¼‰
      this.buildOverPastWall()

      // ç¬¬3å±‚ï¼šç«–ç›´èµ·å§‹çº¿ï¼ˆæœ€ä¸Šå±‚ï¼Œç¡®ä¿å¯è§ï¼‰
      this.buildStartLine()

      // å‚è€ƒéŸ³è°ƒæ¡ï¼ˆæ ¹æ®æ­Œè¯pitchæ•°æ®ï¼‰
      this.buildPitchSticks()

      // ç”¨æˆ·éŸ³è°ƒæŒ‡ç¤ºå™¨
      this.buildLocalPitchIndicator()

      // ç²’å­æ•ˆæœå±‚ï¼ˆæœ€é¡¶å±‚ï¼‰
      if (this.enableParticleEffect && this.particleSystem) {
        ParticleRenderer({ particleSystem: this.particleSystem })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.viewBackgroundColor) // å¯é…ç½®çš„èƒŒæ™¯é¢œè‰²ï¼Œé»˜è®¤#ffffbb33
    .onAreaChange((oldValue: Area, newValue: Area) => {
      // æ›´æ–°è§†å›¾å°ºå¯¸å’Œè®¡ç®—èµ·å§‹ç‚¹ä½ç½®
      this.viewWidth = Number(newValue.width);
      this.viewHeight = Number(newValue.height);
      this.centerXOfStartPoint = this.viewWidth * this.startPointHorizontalBias;
      LogUtils.d(`ScoringView: Area changed - width: ${this.viewWidth}, height: ${this.viewHeight}, centerX: ${this.centerXOfStartPoint}`);
    })
    .onAppear(() => {
      LogUtils.d('ScoringView: Component appeared, setting up event listeners');
      this.setupEventListeners();
      this.initParticleSystem();

      // é€šçŸ¥å¤–éƒ¨ç»„ä»¶ScoringViewå·²å‡†å¤‡å¥½
      setTimeout(() => {
        LogUtils.d('ScoringView: Ready for events, emitting COMPONENT_READY');
        this.eventBus.emit(ScoringEvents.COMPONENT_READY);
      }, 10);
    })
    .onDisAppear(() => {
      LogUtils.d('ScoringView: Component disappearing, cleaning up');
      this.removeEventListeners();
      this.cleanupParticleSystem();
    })
  }

  /**
   * æ„å»ºèƒŒæ™¯çº¿æ¡ - ä½¿ç”¨ç›¸å¯¹å¸ƒå±€ï¼Œä¸ä¾èµ–ç»å¯¹åæ ‡
   */
  @Builder
  buildBackgroundLines() {
    // æ–¹æ¡ˆ1ï¼šä½¿ç”¨Column + justifyContentå‡åŒ€åˆ†å¸ƒ
    Column() {
      // 6æ¡çº¿ï¼Œåˆ›å»º5ä¸ªç­‰åˆ†åŒºåŸŸ
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
      Blank() // è‡ªåŠ¨å¡«å……ç©ºé—´
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
      Blank()
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
      Blank()
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
      Blank()
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
      Blank()
      Line().width('100%').height(this.leadingLinesHeight).backgroundColor(this.leadingLinesColor)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.SpaceBetween) // å‡åŒ€åˆ†å¸ƒ
  }

  /**
   * æ„å»ºæ¸å˜é®ç½©å¢™ - å¯¹åº”Androidçš„drawOverPastWall
   * ä»mCenterXOfStartPointåˆ°å·¦è¾¹ç•Œçš„çº¿æ€§æ¸å˜
   */
  @Builder
  buildOverPastWall() {
    if (this.centerXOfStartPoint > 0 && this.viewWidth > 0 && this.viewHeight > 0) {
      Rect()
        .width(this.centerXOfStartPoint)
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Right, // ä»å·¦åˆ°å³çš„æ¸å˜
          colors: [
            ['#1F24C6FF', 0], // å·¦è¾¹ç•Œ
            ['#00FFFFFF', 1]// å³è¾¹ç•Œ
          ]
        })
        .position({ x: 0, y: 0 })
        .opacity(0.15)
    }
  }

  /**
   * æ„å»ºèµ·å§‹çº¿ - å¯¹åº”Androidçš„drawStartLine
   * åœ¨mCenterXOfStartPointä½ç½®ç»˜åˆ¶ç«–ç›´çº¿ï¼Œä½¿ç”¨pitchIndicatorColor
   */
  @Builder
  buildStartLine() {
    if (this.centerXOfStartPoint > 0 && this.viewWidth > 0 && this.viewHeight > 0) {
      Line()
        .startPoint([this.centerXOfStartPoint, 0])
        .endPoint([this.centerXOfStartPoint, this.viewHeight])
        .stroke(this.pitchIndicatorColor) // ä½¿ç”¨pitchIndicatorColorï¼Œå¯¹åº”Androidå®ç°
        .strokeWidth(this.pitchIndicatorWidth)
    }
  }

  /**
   * æ„å»ºéŸ³è°ƒæ¡ - å¯¹åº”Androidçš„drawPitchSticks
   * æ ¹æ®æ­Œè¯pitchæ•°æ®å’Œå½“å‰è¿›åº¦åŠ¨æ€ç»˜åˆ¶éŸ³è°ƒæ¡ï¼Œæ”¯æŒåˆ†æ®µç€è‰²
   */
  @Builder
  buildPitchSticks() {
    if (this.viewWidth > 0 && this.viewHeight > 0 && this.pitchSticks.length > 0) {
      // ä½¿ç”¨ForEachæ¸²æŸ“æ‰€æœ‰å¯è§çš„pitchæ¡
      ForEach(this.pitchSticks, (stick: PitchStickData, index: number) => {
        Stack() {
          // 1. ç»˜åˆ¶åŸºç¡€pitchæ¡ï¼ˆé»˜è®¤é¢œè‰²ï¼‰
          Rect()
            .width(stick.width)
            .height(stick.height)
            .fill(this.refPitchStickDefaultColor)
            .borderRadius(this.pitchStickRadius)

          // 2. ç»˜åˆ¶å·²ç€è‰²çš„æ®µè½ï¼ˆå¯¹åº”Androidçš„highlightPartMapé€»è¾‘ï¼‰
          ForEach(stick.highlightSegments, (segment: HighlightSegment, segIndex: number) => {
            Rect()
              .width(segment.endX - segment.startX)
              .height(stick.height)
              .fill(this.highlightedPitchStickColor)
              .borderRadius(this.pitchStickRadius)
              .position({
                x: segment.startX - stick.x, // ç›¸å¯¹äºstickçš„ä½ç½®
                y: 0
              })
          }, (segment: HighlightSegment, segIndex: number) => `highlight_${index}_${segIndex}_${segment.startTime}`)

          // 3. ç»˜åˆ¶å½“å‰æ­£åœ¨ç€è‰²çš„éƒ¨åˆ†ï¼ˆå®æ—¶ç€è‰²ï¼‰
          if (stick.isCurrentPitch && stick.isHighlighted) {
            Rect()
              .width(this.calculateCurrentHighlightWidth(stick))
              .height(stick.height)
              .fill(this.highlightedPitchStickColor)
              .borderRadius(this.pitchStickRadius)
              .position({
                x: this.calculateCurrentHighlightStartX(stick) - stick.x,
                y: 0
              })
          }
        }
        .position({
          x: stick.x,
          y: stick.y
        })
      }, (stick: PitchStickData, index: number) => `pitch_${index}_${stick.x}_${stick.y}`)
    }
  }

  /**
   * æ„å»ºç”¨æˆ·éŸ³è°ƒæŒ‡ç¤ºå™¨ - å¯¹åº”Androidçš„drawLocalPitchIndicator
   * åœ¨èµ·å§‹çº¿ä½ç½®ç»˜åˆ¶åœ†å½¢æŒ‡ç¤ºå™¨ï¼ŒYåæ ‡æ ¹æ®å½“å‰éŸ³è°ƒè®¡ç®—
   */
  @Builder
  buildLocalPitchIndicator() {
    if (this.centerXOfStartPoint > 0 && this.viewWidth > 0 && this.viewHeight > 0 && this.pitchIndicatorY >= 0) {
      // ä½¿ç”¨Circleä½œä¸ºéŸ³è°ƒæŒ‡ç¤ºå™¨ï¼Œä½ç½®åœ¨èµ·å§‹çº¿ä¸Šï¼ŒYåæ ‡æ ¹æ®pitchè®¡ç®—
      Circle({ width: this.localPitchIndicatorRadius * 2, height: this.localPitchIndicatorRadius * 2 })
        .fill(this.localPitchIndicatorColor)
        .strokeWidth(2)
        .position({
          x: this.centerXOfStartPoint - this.localPitchIndicatorRadius,
          y: this.pitchIndicatorY - this.localPitchIndicatorRadius
        })
    }
  }

  /**
   * è®¡ç®—éŸ³è°ƒæŒ‡ç¤ºå™¨çš„Yåæ ‡ - å¯¹åº”Androidçš„getYForPitchIndicator
   * æ ¹æ®å½“å‰éŸ³è°ƒå€¼å’ŒéŸ³è°ƒèŒƒå›´è®¡ç®—åœ¨è§†å›¾ä¸­çš„Yä½ç½®
   */
  private calculateYForPitchIndicator(): number {
    let targetY = 0;

    if (this.scoringMachine == null || !this.scoringMachine.isReady()) {
      // æœªåˆå§‹åŒ–æ—¶ï¼ŒæŒ‡ç¤ºå™¨åœ¨åº•éƒ¨
      targetY = this.viewHeight - this.localPitchIndicatorRadius;
    } else if (this.animatedPitch >= this.scoringMachine.getMinimumRefPitch() &&
      this.scoringMachine.getMaximumRefPitch() != 0) {
      // æœ‰æœ‰æ•ˆéŸ³è°ƒå€¼æ—¶ï¼Œæ ¹æ®éŸ³è°ƒèŒƒå›´è®¡ç®—ä½ç½®
      const realPitchMax = this.scoringMachine.getMaximumRefPitch() + 5;
      const realPitchMin = this.scoringMachine.getMinimumRefPitch() - 5;
      const itemHeightPerPitchLevel = this.viewHeight / (realPitchMax - realPitchMin);
      targetY = (realPitchMax - this.animatedPitch) * itemHeightPerPitchLevel;
    } else if (this.animatedPitch < this.scoringMachine.getMinimumRefPitch()) {
      // éŸ³è°ƒè¿‡ä½æ—¶ï¼ŒæŒ‡ç¤ºå™¨åœ¨åº•éƒ¨
      targetY = this.viewHeight;
    } else {
      // éŸ³è°ƒè¿‡é«˜æ—¶ï¼ŒæŒ‡ç¤ºå™¨åœ¨é¡¶éƒ¨
      targetY = 0;
    }

    // ğŸ¯ ä¸¥æ ¼çš„è¾¹ç•Œé™åˆ¶ï¼Œç¡®ä¿pitchå°çƒä¸ä¼šè·‘åˆ°å±å¹•å¤–é¢
    const minY = this.localPitchIndicatorRadius; // é¡¶éƒ¨è¾¹ç•Œï¼Œè€ƒè™‘å°çƒåŠå¾„
    const maxY = this.viewHeight - this.localPitchIndicatorRadius; // åº•éƒ¨è¾¹ç•Œï¼Œè€ƒè™‘å°çƒåŠå¾„
    targetY = Math.max(minY, Math.min(maxY, targetY));

    return targetY;
  }

  /**
   * è·å–æ¸²æŸ“è¿›åº¦ - å¯¹åº”Androidçš„getRenderProgressMs()
   * ä½¿ç”¨å¹³æ»‘çš„animatedProgressMsç”¨äºåŠ¨ç”»æ•ˆæœ
   */
  private getRenderProgressMs(): number {
    return Math.round(this.animatedProgressMs);
  }

  /**
   * è·å–å®æ—¶æ’­æ”¾è¿›åº¦ - ç”¨äºpitchæ¡ä½ç½®è®¡ç®—
   * ä¸ä½¿ç”¨å¹³æ»‘å¤„ç†ï¼Œç¡®ä¿æ—¶åºå‡†ç¡®
   */
  private getRealTimeProgressMs(): number {
    if (this.scoringMachine) {
      return this.scoringMachine.getCurrentPitchProgress();
    }
    return this.animatedProgressMs;
  }

  /**
   * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
   */
  private setupEventListeners(): void {
    LogUtils.d('ScoringView: Setting up event listeners');

    // åˆå§‹åŒ–ScoringMachine
    this.initScoringMachine();

    // å“åº”ç»„ä»¶æ£€æµ‹è¯·æ±‚
    this.eventBus.on(KaraokeEvents.COMPONENT_DETECTION, (request: string) => {
      if (request === KaraokeEvents.COMPONENT_DETECTION_REQUEST) {
        LogUtils.d('ScoringView: Responding to component detection');
        this.eventBus.emit(KaraokeEvents.COMPONENT_DETECTION, KaraokeEvents.COMPONENT_SCORING_VIEW);
      }
    });

    // ç›‘å¬æ­Œè¯æ•°æ®è®¾ç½®äº‹ä»¶
    this.eventBus.on(ScoringEvents.SET_LYRIC_DATA, (lyricModel: LyricModel, usingInternalScoring: boolean) => {
      if (this.scoringMachine) {
        this.scoringMachine.prepare(lyricModel, usingInternalScoring);
        LogUtils.d(`ScoringView: Lyric data prepared in ScoringMachine with usingInternalScoring: ${usingInternalScoring}`);
      } else {
        LogUtils.e('ScoringView: ScoringMachine is null when receiving SET_LYRIC_DATA event');
      }
    });

    this.eventBus.on(ScoringEvents.SET_PROGRESS, (progress: number) => {
      if (this.scoringMachine) {
        this.scoringMachine.setLyricProgress(progress);
      }
    });

    // ç›‘å¬éŸ³é«˜æ•°æ®è®¾ç½®äº‹ä»¶
    this.eventBus.on(ScoringEvents.SET_PITCH, (speakerPitch: number, pitchScore: number) => {
      if (this.scoringMachine) {
        this.scoringMachine.setPitch(speakerPitch, pitchScore);
      }
    });

    // ç›‘å¬è¯„åˆ†ç®—æ³•è®¾ç½®äº‹ä»¶
    this.eventBus.on(ScoringEvents.SET_SCORING_ALGORITHM, (algorithm: IScoringAlgorithm) => {
      LogUtils.d('ScoringView: Received SET_SCORING_ALGORITHM event');
      if (this.scoringMachine) {
        this.scoringMachine.setScoringAlgorithm(algorithm);
        LogUtils.d('ScoringView: Scoring algorithm set successfully');
      } else {
        LogUtils.e('ScoringView: ScoringMachine is null when receiving SET_SCORING_ALGORITHM event');
      }
    });

    // ç›‘å¬è¯„åˆ†éš¾åº¦è®¾ç½®äº‹ä»¶
    this.eventBus.on(ScoringEvents.SET_SCORING_LEVEL, (level: number) => {
      LogUtils.d(`ScoringView: Received SET_SCORING_LEVEL event, level: ${level}`);
      if (this.scoringMachine) {
        this.scoringMachine.setScoringLevel(level);
        LogUtils.d(`ScoringView: Scoring level set to ${level} successfully`);
      } else {
        LogUtils.e('ScoringView: ScoringMachine is null when receiving SET_SCORING_LEVEL event');
      }
    });
  }

  /**
   * ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
   */
  private removeEventListeners(): void {
    LogUtils.d('ScoringView: Removing event listeners');
    this.stopFrameLoop();
  }

  /**
   * åˆå§‹åŒ–ScoringMachine
   */
  private initScoringMachine(): void {
    if (!this.scoringMachine) {
      LogUtils.d('ScoringView: Creating new ScoringMachine');

      /**
       * ScoringMachineç›‘å¬å™¨å®ç°ç±»
       */
      class ScoringViewListener implements OnScoringListener {
        private scoringView: ScoringView;

        constructor(scoringView: ScoringView) {
          this.scoringView = scoringView;
        }

        onLineFinished(line: LyricsLineModel, score: number, cumulativeScore: number, index: number,
          lineCount: number): void {
          LogUtils.d(`ScoringView: Line finished - score: ${score}, cumulative: ${cumulativeScore}`);
          this.scoringView.handleLineFinished(score, cumulativeScore);
        }

        resetUi(): void {
          LogUtils.d('ScoringView: resetUi called from ScoringMachine');
          this.scoringView.resetPitchIndicatorAndAnimation();
        }

        requestRefreshUi(): void {
          this.scoringView.requestRefreshUi();
        }

        onPitchAndScoreUpdate(speakerPitch: number, scoreAfterNormalization: number, progress: number): void {
          this.scoringView.updatePitchAndScore(speakerPitch, scoreAfterNormalization);
        }
      }

      const listener = new ScoringViewListener(this);
      this.scoringMachine = new ScoringMachine(listener);

      // è®¾ç½®åˆå§‹åˆ†æ•°
      this.scoringMachine.setInitialScore(this.initialScore);

      LogUtils.d('ScoringView: ScoringMachine created successfully');

      // å¯åŠ¨å¸§å¾ªç¯ç”¨äºåŠ¨ç”»æ›´æ–°
      this.startFrameLoopIfNeeded();
    } else {
      LogUtils.d('ScoringView: ScoringMachine already exists');
    }
  }

  /**
   * å¤„ç†è¡Œå®Œæˆäº‹ä»¶
   */
  handleLineFinished(score: number, cumulativeScore: number): void {
    this.currentScore = score;
    this.cumulativeScore = cumulativeScore;
    this.resetPitchIndicatorAndAnimationWhenFullLineFinished(score);
  }

  /**
   * å¯åŠ¨å¸§å¾ªç¯ï¼ˆç”¨äºåŠ¨ç”»æ›´æ–°ï¼‰
   */
  private startFrameLoopIfNeeded(): void {
    if (this.frameLoopRunning) {
      return;
    }

    this.frameLoopRunning = true;

    const frameLoop = () => {
      if (!this.frameLoopRunning) {
        return;
      }

      // æŒ‡æ•°å¹³æ»‘ç®—æ³• - å®Œå…¨å¯¹åº”Androidç‰ˆæœ¬çš„å®ç°
      // å¯¹åº”Java: float tauMs = 120f; float alpha = 1f - (float) Math.exp(-dtMs / tauMs);
      const tauMs = 120; // å¹³æ»‘å¸¸æ•°ï¼Œå¯¹åº”Javaç‰ˆæœ¬çš„120f
      const dtMs = 16; // å¸§é—´éš”16ms (60fps)
      const alpha = 1 - Math.exp(-dtMs / tauMs);

      // æ™ºèƒ½pitchæ›´æ–°ï¼šåªå¯¹ä»æ— å£°åˆ°æœ‰å£°ç«‹å³å“åº”ï¼Œå…¶ä»–æƒ…å†µä½¿ç”¨å¹³æ»‘åŠ¨ç”»
      const oldAnimatedPitch = this.animatedPitch;
      const wasZero = this.lastLocalPitch === 0;
      const isZero = this.localPitch === 0;
      const isNonZero = this.localPitch !== 0;

      if (wasZero && isNonZero) {
        // ç«‹å³å“åº”ï¼šä»0åˆ°é0ï¼ˆç¡®ä¿ç€è‰²ç«‹å³å¼€å§‹ï¼‰
        this.animatedPitch = this.localPitch;
      } else {
        // å¹³æ»‘åŠ¨ç”»ï¼šæ‰€æœ‰å…¶ä»–æƒ…å†µï¼ŒåŒ…æ‹¬ä»æœ‰å€¼åˆ°0ï¼ˆè®©ç»“å°¾æ›´å¹³æ»‘ï¼‰
        this.animatedPitch = this.animatedPitch + (this.localPitch - this.animatedPitch) * alpha;
      }

      // æ›´æ–°ä¸Šä¸€æ¬¡çš„pitchå€¼ç”¨äºä¸‹æ¬¡åˆ¤æ–­
      this.lastLocalPitch = this.localPitch;

      // æ›´æ–°éŸ³è°ƒæŒ‡ç¤ºå™¨çš„Yåæ ‡
      this.pitchIndicatorY = this.calculateYForPitchIndicator();

      // æ›´æ–°pitchæ¡æ•°æ®
      this.updatePitchSticks();

      // æ›´æ–°ç²’å­å‘å°„ç‚¹ä½ç½®
      this.updateParticleEmissionPoint();

      // å¹³æ»‘æ›´æ–°åŠ¨ç”»è¿›åº¦
      if (this.scoringMachine) {
        const machineProgress = this.scoringMachine.getCurrentPitchProgress();
        if (Math.abs(this.animatedProgressMs - machineProgress) > 2000) {
          this.animatedProgressMs = machineProgress; // å¤§è·³è·ƒæ—¶ç›´æ¥è®¾ç½®
        } else {
          this.animatedProgressMs = this.animatedProgressMs + (machineProgress - this.animatedProgressMs) * alpha;
        }
      }

      // ç»§ç»­ä¸‹ä¸€å¸§
      this.frameTimer = setTimeout(frameLoop, 16); // çº¦60fps
    };

    frameLoop();
  }

  /**
   * åœæ­¢å¸§å¾ªç¯
   */
  private stopFrameLoop(): void {
    this.frameLoopRunning = false;
    if (this.frameTimer !== -1) {
      clearTimeout(this.frameTimer);
      this.frameTimer = -1;
    }
  }

  /**
   * é‡ç½®è¯„åˆ†æ˜¾ç¤º
   */
  reset(): void {
    this.localPitch = 0;
    this.animatedPitch = 0;
    this.animatedProgressMs = 0;
    this.inHighlightStatus = false;
    this.preHighlightStatus = false;
    this.currentScore = 0;
    this.cumulativeScore = 0;
    this.pitchSticks = [];
    this.lastLocalPitch = 0; // é‡ç½®pitchçŠ¶æ€è·Ÿè¸ª
  }

  /**
   * æ›´æ–°éŸ³è°ƒå’Œå¾—åˆ† - å¯¹åº”Androidçš„updatePitchAndScore
   * æ™ºèƒ½æ›´æ–°pitchå€¼ï¼šç«‹å³å“åº”0å€¼å˜åŒ–ï¼Œå…¶ä»–æƒ…å†µç”±å¸§å¾ªç¯å¹³æ»‘å¤„ç†
   */
  updatePitchAndScore(pitch: number, score: number): void {
    const oldLocalPitch = this.localPitch;
    this.localPitch = pitch;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³æ›´æ–°Yåæ ‡ï¼ˆåªå¯¹ä»æ— å£°åˆ°æœ‰å£°ç«‹å³å“åº”ï¼‰
    const wasZero = oldLocalPitch === 0;
    const isNonZero = pitch !== 0;

    if (wasZero && isNonZero) {
      // ç«‹å³æ›´æ–°animatedPitchå’ŒYåæ ‡ï¼Œç¡®ä¿ç€è‰²é€»è¾‘èƒ½ç«‹å³å“åº”
      this.animatedPitch = pitch;
      this.pitchIndicatorY = this.calculateYForPitchIndicator();
      this.lastLocalPitch = pitch;

      // é‡ç½®ç€è‰²çŠ¶æ€ï¼Œç¡®ä¿æ–°çš„æ¼”å”±å‘¨æœŸèƒ½æ­£ç¡®å¼€å§‹
      this.preHighlightStatus = false;
      this.pitchHighlightedTime = -1;

      // ç«‹å³è§¦å‘pitchæ¡æ•°æ®æ›´æ–°ï¼Œç¡®ä¿ç€è‰²èƒ½ç«‹å³ç”Ÿæ•ˆ
      this.updatePitchSticks();
    }

    // åŸºäºå¤–éƒ¨ä¼ å…¥çš„scoreè®¾ç½®ç€è‰²çŠ¶æ€ï¼ˆå¯¹åº”Androidé€»è¾‘ï¼‰
    this.inHighlightStatus = score >= this.hitScoreThreshold * 100;

    // åŸºäºå¤–éƒ¨ä¼ å…¥çš„scoreç¡®ä¿ç²’å­åŠ¨ç”»ï¼ˆå¯¹åº”Androidçš„assureAnimationForPitchIndicatorï¼‰
    this.assureParticleAnimation(score);

    this.startFrameLoopIfNeeded();
  }

  /**
   * è®¡ç®—å½“å‰ç€è‰²æ®µçš„å®½åº¦ - å¯¹åº”Androidçš„å®æ—¶ç€è‰²é€»è¾‘
   */
  private calculateCurrentHighlightWidth(stick: PitchStickData): number {
    if (this.pitchHighlightedTime === -1) {
      return 0;
    }

    // å¯¹åº”Androidçš„40msä¸€æ®µç€è‰²é€»è¾‘
    const INTERVAL_AUDIO_PCM = 40; // 40msé—´éš”
    const realTimeProgress = this.getRealTimeProgressMs();
    const highlightEndX = this.centerXOfStartPoint - this.movingPixelsPerMs * INTERVAL_AUDIO_PCM;
    const highlightStartX =
      this.centerXOfStartPoint + (this.pitchHighlightedTime - realTimeProgress) * this.movingPixelsPerMs;

    return Math.max(0, highlightEndX - highlightStartX);
  }

  /**
   * è®¡ç®—å½“å‰ç€è‰²æ®µçš„èµ·å§‹Xåæ ‡
   */
  private calculateCurrentHighlightStartX(stick: PitchStickData): number {
    if (this.pitchHighlightedTime === -1) {
      return stick.x;
    }

    const realTimeProgress = this.getRealTimeProgressMs();
    return this.centerXOfStartPoint + (this.pitchHighlightedTime - realTimeProgress) * this.movingPixelsPerMs;
  }

  /**
   * æ›´æ–°pitchæ¡æ•°æ® - å¯¹åº”Androidçš„drawPitchSticksé€»è¾‘
   * å®ç°åˆ†æ®µç€è‰²å’ŒæŒä¹…ç€è‰²æ•ˆæœ
   */
  private updatePitchSticks(): void {
    if (!this.scoringMachine) {
      LogUtils.d('ScoringView: No scoring machine');
      this.pitchSticks = [];
      return;
    }

    if (!this.scoringMachine.isReady()) {
      LogUtils.d('ScoringView: Scoring machine not ready');
      this.pitchSticks = [];
      return;
    }

    if (!this.scoringMachine.hasPitchData()) {
      LogUtils.d('ScoringView: No pitch data available');
      this.pitchSticks = [];
      return;
    }

    const renderProgress = this.getRenderProgressMs();
    const pitchLines = this.scoringMachine.getPitchLines();

    if (!pitchLines || pitchLines.length === 0) {
      LogUtils.d('ScoringView: No pitch lines available');
      this.pitchSticks = [];
      return;
    }

    const realPitchMax = this.scoringMachine.getMaximumRefPitch() + 5;
    const realPitchMin = this.scoringMachine.getMinimumRefPitch() - 5;
    const stickHeightPerPitchLevel = (this.viewHeight - this.pitchStickHeight) / (realPitchMax - realPitchMin);

    const newPitchSticks: PitchStickData[] = [];

    // éå†æ‰€æœ‰pitchè¡Œ
    for (let i = 0; i < pitchLines.length; i++) {
      const line = pitchLines[i];
      const pitches = line.pitches;

      if (!pitches || pitches.length === 0) {
        continue;
      }

      // æ£€æŸ¥æ˜¯å¦åœ¨å¯è§èŒƒå›´å†…
      const lineStartTime = line.getStartTime();
      const lineEndTime = line.getEndTime();

      if (Math.abs(renderProgress - lineEndTime) * this.movingPixelsPerMs >= this.viewWidth &&
        Math.abs(renderProgress - lineStartTime) * this.movingPixelsPerMs >= this.viewWidth &&
        !(renderProgress >= lineStartTime && renderProgress <= lineEndTime)) {
        continue; // ä¸åœ¨å¯è§èŒƒå›´å†…
      }

      // éå†è¯¥è¡Œçš„æ‰€æœ‰pitch
      for (let pitchIndex = 0; pitchIndex < pitches.length; pitchIndex++) {
        const pitch = pitches[pitchIndex];

        // è®¡ç®—pitchæ¡çš„Xåæ ‡å’Œå®½åº¦ï¼ˆä½¿ç”¨å®æ—¶è¿›åº¦ç¡®ä¿ä¸æ­Œè¯æ—¶åºåŒæ­¥ï¼‰
        const realTimeProgress = this.getRealTimeProgressMs();
        const pixelsAwayFromPilot = (pitch.begin - realTimeProgress) * this.movingPixelsPerMs;
        const x = this.centerXOfStartPoint + pixelsAwayFromPilot;
        const width = this.movingPixelsPerMs * pitch.getDuration();
        const endX = x + width;

        // è§†å£è£å‰ªï¼šè·³è¿‡ä¸å¯è§çš„pitchæ¡
        if (endX <= 0) {
          // å½“pitchæ¡ç§»å‡ºå±å¹•æ—¶ï¼Œé‡ç½®é«˜äº®çŠ¶æ€
          pitch.resetHighlight();
          continue;
        }
        if (x >= this.viewWidth) {
          break;
        }

        // è®¡ç®—Yåæ ‡
        const y = (realPitchMax - pitch.pitch) * stickHeightPerPitchLevel;

        // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ­£åœ¨æ¼”å”±çš„pitchï¼ˆä½¿ç”¨å®æ—¶è¿›åº¦ç¡®ä¿æ—¶åºå‡†ç¡®ï¼‰
        const isCurrentPitch = realTimeProgress >= pitch.begin && realTimeProgress <= pitch.end;

        // å¤„ç†ç€è‰²é€»è¾‘ - å¯¹åº”Androidçš„highlightPartMapé€»è¾‘ï¼ˆä½¿ç”¨å®æ—¶è¿›åº¦ï¼‰
        this.processHighlightLogic(pitch, isCurrentPitch, realTimeProgress);

        // æ„å»ºç€è‰²æ®µæ•°æ®ï¼ˆä½¿ç”¨å®æ—¶è¿›åº¦ç¡®ä¿æ—¶åºä¸€è‡´ï¼‰
        const highlightSegments = this.buildHighlightSegments(pitch, realTimeProgress, x, width);

        // åˆ¤æ–­æ˜¯å¦é«˜äº®ï¼ˆåŸºäºæ¼”å”±çŠ¶æ€ï¼‰
        const isHighlighted = isCurrentPitch && this.inHighlightStatus;

        newPitchSticks.push({
          x: x,
          y: y,
          width: width,
          height: this.pitchStickHeight,
          pitch: pitch.pitch,
          isHighlighted: isHighlighted,
          isCurrentPitch: isCurrentPitch,
          highlightSegments: highlightSegments
        });
      }
    }

    this.pitchSticks = newPitchSticks;
  }

  /**
   * å¤„ç†ç€è‰²é€»è¾‘ - å¯¹åº”Androidçš„highlightPartMapå¤„ç†
   */
  private processHighlightLogic(pitch: Pitch, isCurrentPitch: boolean, realTimeProgress: number): void {
    const INTERVAL_AUDIO_PCM = 40; // 40msé—´éš”ï¼Œå¯¹åº”Androidçš„Constants.INTERVAL_AUDIO_PCM

    if (!isCurrentPitch) {
      // ä¸æ˜¯å½“å‰pitchæ—¶ï¼Œå®Œæˆæ‰€æœ‰æœªå®Œæˆçš„ç€è‰²æ®µ
      const keys = Array.from(pitch.highlightPartMap.keys());
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const value = pitch.highlightPartMap.get(key);
        if (value === null) {
          pitch.highlightPartMap.set(key, { first: key, second: pitch.end });
        }
      }
    }

    if (isCurrentPitch) {
      if (this.inHighlightStatus) {
        // å¼€å§‹æ–°çš„ç€è‰²æ®µ
        if (!this.preHighlightStatus) {
          this.pitchHighlightedTime = realTimeProgress;
          if (realTimeProgress - pitch.begin < INTERVAL_AUDIO_PCM) {
            this.pitchHighlightedTime = pitch.begin;
          }
          this.preHighlightStatus = this.inHighlightStatus;
        }

        // è®°å½•ç€è‰²æ®µå¼€å§‹
        if (!pitch.highlightPartMap.has(this.pitchHighlightedTime)) {
          pitch.highlightPartMap.set(this.pitchHighlightedTime, null);
        }
      } else {
        // ç»“æŸç€è‰²æ®µ
        this.preHighlightStatus = false;
        if (this.pitchHighlightedTime !== -1) {
          pitch.highlightPartMap.set(this.pitchHighlightedTime, {
            first: this.pitchHighlightedTime,
            second: realTimeProgress
          });
          this.pitchHighlightedTime = -1;
        }
      }
    } else {
      // ä¸æ˜¯å½“å‰pitchæ—¶é‡ç½®çŠ¶æ€
      if (this.preHighlightStatus) {
        this.preHighlightStatus = false;
      }
      if (this.pitchHighlightedTime !== -1) {
        this.pitchHighlightedTime = -1;
      }
    }
  }

  /**
   * æ„å»ºç€è‰²æ®µæ•°æ® - å°†highlightPartMapè½¬æ¢ä¸ºUIå¯ç”¨çš„HighlightSegmentæ•°ç»„
   */
  private buildHighlightSegments(pitch: Pitch, renderProgress: number, pitchX: number,
    pitchWidth: number): HighlightSegment[] {
    const segments: HighlightSegment[] = [];

    // åªå¤„ç†å·²ç»ç§»åŠ¨åˆ°èµ·å§‹çº¿å·¦ä¾§çš„pitchæ¡
    if (pitchX < this.centerXOfStartPoint) {
      const keys = Array.from(pitch.highlightPartMap.keys());
      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];
        const value = pitch.highlightPartMap.get(key);
        if (value !== null && value !== undefined) {
          // å®Œæˆçš„ç€è‰²æ®µ
          const highlightStartTime = value.first;
          const highlightEndTime = value.second;

          const highlightStartX =
            this.centerXOfStartPoint + (highlightStartTime - renderProgress) * this.movingPixelsPerMs;
          const highlightEndX = highlightStartX + this.movingPixelsPerMs * (highlightEndTime - highlightStartTime);

          // ç¡®ä¿ç€è‰²æ®µåœ¨pitchæ¡èŒƒå›´å†…
          const clampedStartX = Math.max(highlightStartX, pitchX);
          const clampedEndX = Math.min(highlightEndX, pitchX + pitchWidth);

          if (clampedEndX > clampedStartX) {
            segments.push({
              startX: clampedStartX,
              endX: clampedEndX,
              startTime: highlightStartTime,
              endTime: highlightEndTime
            });
          }
        } else {
          // æ­£åœ¨è¿›è¡Œçš„ç€è‰²æ®µï¼ˆå½“å‰æ­£åœ¨å”±ï¼‰
          if (pitch.begin <= renderProgress && renderProgress <= pitch.end) {
            const highlightStartTime = key;
            const highlightStartX =
              this.centerXOfStartPoint + (highlightStartTime - renderProgress) * this.movingPixelsPerMs;
            const highlightEndX = this.centerXOfStartPoint;

            const clampedStartX = Math.max(highlightStartX, pitchX);
            const clampedEndX = Math.min(highlightEndX, pitchX + pitchWidth);

            if (clampedEndX > clampedStartX) {
              segments.push({
                startX: clampedStartX,
                endX: clampedEndX,
                startTime: highlightStartTime,
                endTime: renderProgress
              });
            }
          }
        }
      }
    }

    return segments;
  }

  /**
   * é‡ç½®éŸ³è°ƒæŒ‡ç¤ºå™¨å’ŒåŠ¨ç”»
   */
  resetPitchIndicatorAndAnimation(): void {
    this.inHighlightStatus = false;
    this.localPitch = 0;
    this.pitchHighlightedTime = -1; // é‡ç½®ç€è‰²æ—¶é—´
  }

  /**
   * å½“æ•´è¡Œå®Œæˆæ—¶é‡ç½®éŸ³è°ƒæŒ‡ç¤ºå™¨å’ŒåŠ¨ç”»
   */
  resetPitchIndicatorAndAnimationWhenFullLineFinished(score: number): void {
    if (score === 0) {
      this.inHighlightStatus = false;
      this.localPitch = 0;
    }
  }

  /**
   * è¯·æ±‚åˆ·æ–°UI
   */
  requestRefreshUi(): void {
    // UIä¼šè‡ªåŠ¨æ›´æ–°
  }

  /**
   * åˆ›å»ºç²’å­é…ç½®
   */
  private createParticleConfig(): Partial<ParticleConfig> {
    const speedRange: Range = { min: 1.0, max: 3.0 }; // å¢åŠ é€Ÿåº¦ï¼Œä½¿ç²’å­æ›´å®¹æ˜“çœ‹åˆ°
    const angleRange: Range = { min: 130, max: 230 };
    const rotationSpeedRange: Range = { min: 90, max: 180 };
    const scaleRange: Range = { min: 0.3, max: 0.5 }; // è°ƒæ•´ä¸ºæ›´åˆé€‚çš„ç²’å­å¤§å°

    const config: Partial<ParticleConfig> = {
      particlesPerSecond: 60, // è¿›ä¸€æ­¥å¢åŠ å‘å°„é¢‘ç‡ï¼Œç¡®ä¿ç€è‰²æ—¶ç«‹å³æœ‰å¤§é‡ç²’å­
      maxParticles: 80, // è¿›ä¸€æ­¥å¢åŠ æœ€å¤§ç²’å­æ•°é‡
      particleLifetime: 800, // å»¶é•¿ç²’å­ç”Ÿå‘½å‘¨æœŸåˆ°1.5ç§’ï¼Œè®©ç²’å­æ›´æŒä¹…
      speedRange: speedRange, // å¯¹åº”Androidçš„setSpeedModuleAndAngleRange
      angleRange: angleRange, // å¯¹åº”Androidçš„130, 230åº¦
      rotationSpeedRange: rotationSpeedRange, // å¯¹åº”Androidçš„setRotationSpeedRange
      scaleRange: scaleRange, // å¯¹åº”Androidçš„setScaleRange
      fadeOutDuration: 50 // å»¶é•¿æ·¡å‡ºæ—¶é—´ï¼Œè®©ç²’å­æ›´æ˜æ˜¾
    };

    return config;
  }

  /**
   * åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ - å¯¹åº”Androidçš„initParticleSystem
   */
  private initParticleSystem(): void {
    if (this.enableParticleEffect) {
      LogUtils.d('ScoringView: Initializing particle system');
      this.particleSystem = new ParticleSystem(this.createParticleConfig());
      LogUtils.d('ScoringView: Particle system initialized successfully');
    }
  }

  /**
   * æ¸…ç†ç²’å­ç³»ç»Ÿ
   */
  private cleanupParticleSystem(): void {
    if (this.particleSystem) {
      LogUtils.d('ScoringView: Cleaning up particle system');
      this.particleSystem.cancel();
      this.particleSystem = null;
      this.emittingInitialized = false;
    }
  }

  /**
   * ç¡®ä¿ç²’å­åŠ¨ç”»æ•ˆæœ - å¯¹åº”Androidçš„assureAnimationForPitchIndicator
   */
  private assureParticleAnimation(scoreAfterNormalization: number): void {
    if (!this.enableParticleEffect || !this.particleSystem) {
      return;
    }

    // å¯¹åº”Androidçš„ç²’å­åŠ¨ç”»é€»è¾‘ï¼šåŸºäºscoreé˜ˆå€¼åˆ¤æ–­
    if (scoreAfterNormalization >= this.hitScoreThreshold * 100) {

      if (!this.emittingInitialized) {
        // ç²’å­åŠ¨ç”»ä½ç½®åœ¨å½“å‰æ¼”å”±çº¿ï¼ˆcenterXOfStartPointï¼‰ï¼Œå¯¹åº”Androidé€»è¾‘
        const emitX = this.centerXOfStartPoint;
        const emitY = this.pitchIndicatorY;

        this.particleSystem.emit(emitX, emitY);
        this.emittingInitialized = true;
      } else {
        // æ›´æ–°å‘å°„ç‚¹ä½ç½® - å¯¹åº”Androidçš„updateEmitPoint
        this.particleSystem.updateEmitPoint(this.centerXOfStartPoint, this.pitchIndicatorY);
      }

      // æ¢å¤å‘å°„ - å¯¹åº”Androidçš„resumeEmittingï¼Œè¿™ä¼šç«‹å³åˆ›å»ºç²’å­
      this.particleSystem.resumeEmitting();
    } else {
      // åˆ†æ•°ä½äºé˜ˆå€¼ï¼Œåœæ­¢å‘å°„ç²’å­
      if (this.particleSystem) {
        this.particleSystem.stopEmitting(); // å¯¹åº”Androidçš„stopEmitting
      }
    }
  }

  /**
   * æ›´æ–°ç²’å­å‘å°„ç‚¹ä½ç½® - åœ¨å¸§å¾ªç¯ä¸­è°ƒç”¨
   */
  private updateParticleEmissionPoint(): void {
    if (this.enableParticleEffect && this.particleSystem && this.inHighlightStatus) {
      // å¹³æ»‘æ›´æ–°ç²’å­å‘å°„ç‚¹ä½ç½® - å¯¹åº”Androidçš„å¸§å¾ªç¯ä¸­çš„ç²’å­ä½ç½®æ›´æ–°
      this.particleSystem.updateEmitPoint(this.centerXOfStartPoint, this.pitchIndicatorY);
    }
  }
}
